name: CI/CD Pipeline - Deploy to Mac

on:
  push:
    branches:
      - main  # Trigger on push to main branch

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'   # Your Node.js version

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test
        # Make sure you have a test script in package.json

      - name: Build Docker image
        run: docker build -t devops-demo-app .

      - name: Deploy to Mac via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.mac_SSH_KEY }}
          MAC_USER: ${{ secrets.MAC_USER }}
          MAC_IP: ${{ secrets.MAC_IP }}
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key
          chmod 600 private_key
          ssh -i private_key -o StrictHostKeyChecking=no $MAC_USER@$MAC_IP "
            cd /Users/$MAC_USER/Desktop/devops-demo-app &&
            docker-compose down &&
            docker-compose build &&
            docker-compose up -d
          "
        